
@startuml
skinparam sequence {
  ActorBorderColor #333333
  LifeLineBorderColor #666666
  LifeLineBackgroundColor #F5F5F5
  ParticipantBorderColor #333333
  ParticipantBackgroundColor #E8E8E8
  ParticipantFontSize 13
}

title **Forgot Password Flow**\nPOST /api/auth/forgot-password
header Password Reset Request Sequence
footer Page 1 of 1

actor "HTTP Client" as Client
boundary "Server" as Server
control "Controller" as Controller
control "Service" as Service
control "Unit of Work" as UoW
entity "Repository" as Repository
entity "Mapper" as Mapper
database "Database" as Database
control "Mailer" as Mailer

autonumber "<b>[000]"

Client -[#CC3300]> Server : POST /api/auth/forgot-password
activate Client

Server -[#CC3300]> Controller : Routing & Middleware
activate Server
activate Controller

Controller -> Controller : Parsing Email
Controller -[#CC3300]> Service : Orkestrasi Logika Reset Password
deactivate Controller
activate Service

Service -[#CC3300]> UoW : Akses Repository
activate UoW

UoW -[#CC3300]> Repository : Pencarian User by Email
activate Repository

Repository -[#CC3300]> Mapper : Transformasi Model -> Entity
activate Mapper

Mapper -[#CC3300]> Database : Query Data
activate Database
Database -[#006600]-> Mapper : User Data / Null
deactivate Database

alt User Found
    Mapper -[#006600]-> Repository : User Entity
    deactivate Mapper
    
    Repository -[#006600]-> Service : User Entity
    deactivate Repository
    
    UoW -> UoW : Close Transaction
    UoW -[#006600]-> Service : Data Ready
    deactivate UoW
    
    Service -> Service : Generasi Token: UUID Random
    Service -[#CC6600]> Repository : Persistensi Token: Password Reset Token
    activate Repository
    
    Repository -[#CC6600]> Mapper : Entity -> Model
    activate Mapper
    
    Mapper -[#CC6600]> Database : Insert Data
    activate Database
    Database -[#006600]-> Mapper : Success
    deactivate Database
    
    Mapper -[#006600]-> Repository : Token Persisted
    deactivate Mapper
    
    Repository -[#006600]-> Service : Token Created
    deactivate Repository
    
    Service -[#CC6600]> Mailer : Pengiriman Email dengan Link Reset (Async)
    activate Mailer
    Mailer -[#006600]-> Service : Email Queued
    deactivate Mailer
else User Not Found
    Mapper -[#990000]-> Repository : Null
    deactivate Mapper
    
    Repository -[#990000]-> Service : Null (silent fail)
    deactivate Repository
    
    UoW -> UoW : Close Transaction
    UoW -[#006600]-> Service : Complete
    deactivate UoW
end

Service -[#006600]-> Server : HTTP Response JSON (Generic Success)
deactivate Service

Server -> Server : Format Response
Server -[#006600]-> Client : JSON Response\n{"success": true, "message": "If email exists, reset token sent"}
deactivate Server

Client -> Client : Display Success Message
deactivate Client

@enduml

