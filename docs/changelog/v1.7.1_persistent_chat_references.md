# Changelog: Persistent Chat Note References

## Version: v1.7.0
**Date:** 2026-01-05
**Author:** Backend Team

## Overview
This update introduces persistent storage for note references in chat messages. Previously, references (e.g., explicit mentions of notes) were ephemeral and lost upon page refresh. Now, they are stored in the database and retrieved with chat history.

## Changes

### Database
- **[NEW TABLE]** `chat_message_references`
    - Links `chat_messages` to `notes`.
    - Columns: `id` (UUID), `chat_message_id` (UUID), `note_id` (UUID), `created_at`, `updated_at`.
    - Constraints: Foreign keys with `ON DELETE CASCADE`.

### Repositories
- **[NEW]** `ChatMessageReferenceRepository`
    - `CreateBulk(ctx, references)`: Persists multiple references at once.
    - `FindAllByMessageIds(ctx, ids)`: Retrieves values for a batch of messages.

### Services
- **[UPDATE]** `ChatbotService`
    - `SendChat`: Now resolves references and executes a persistent save to `chat_message_references`.
    - `GetChatHistory`: Fetches associated references for all loaded messages and attaches them to the response DTO.

### API & DTOs
- **[UPDATE]** `GetChatHistoryResponse`
    - Added `references` field: `[]ResolvedReferenceDTO`.
    ```json
    {
        "id": "...",
        "role": "user",
        "chat": "Analyze this note",
        "references": [
            {
                "note_id": "...",
                "title": "Project Alpha",
                "resolved": true
            }
        ]
    }
    ```

## Post-Migration Verification
- **Build:** Checked via `go build ./...`
- **Migration:** Registed `model.ChatMessageReference` in `cmd/migrate/main.go`.
