# API Changelog: AI Pipeline Configuration System

**Version**: 1.4.0  
**Date**: 2026-01-02  
**Type**: Feature Addition

---

## Overview

This release introduces a configurable AI pipeline that supports:
- **Bypass Mode** (`/bypass`) - Direct LLM chat without RAG
- **Nuance Mode** (`/nuance:key`) - Behavioral modification via injected prompts
- **Model Override** - Nuances can trigger runtime model switching (e.g. use `deepseek-coder` for coding)
- **Admin API** - Full CRUD for AI configuration and nuances
- **Public API** - Endpoint for fetching available nuances

---

## New Chat Behavior

### Prompt Prefixes

| Prefix | Example | Behavior |
|--------|---------|----------|
| `/bypass` | `/bypass What is 2+2?` | Pure LLM, skips note retrieval |
| `/nuance:key` | `/nuance:engineering Analyze code` | Pure LLM with injected system prompt |
| *(none)* | `What's in my notes?` | Full RAG (unchanged) |

### Response Format Change

The chat response now includes optional `mode` and `nuance_key` fields:

```typescript
interface SendChatResponse {
  reply: string;
  citations?: CitationDTO[];
  mode?: "rag" | "bypass" | "nuance";  // NEW
  nuance_key?: string;                  // NEW (only if mode=nuance)
}
```

---

## New Admin Endpoints

### AI Configuration (Admin Only)

```
GET    /api/admin/ai/configurations
PUT    /api/admin/ai/configurations/:key
```

### AI Nuances (Admin Only)

```
GET    /api/admin/ai/nuances
POST   /api/admin/ai/nuances
PUT    /api/admin/ai/nuances/:id
DELETE /api/admin/ai/nuances/:id
```

## New User Endpoint

### Available Nuances (For Autocomplete)

```
GET    /api/chatbot/v1/nuances
```

Returns active nuances for user-facing autocomplete/help display.

---

## Database Changes

### New Tables

| Table | Purpose |
|-------|---------|
| `ai_configurations` | Key-value AI settings |
| `ai_nuances` | Reusable prompt templates |

### Migration Required

```bash
go run cmd/migrate/main.go
go run cmd/seed_ai_config/main.go
```

---

## Default Data (Seeded)

### Configurations

| Key | Default |
|-----|---------|
| `rag_similarity_threshold` | 0.7 |
| `rag_max_results` | 5 |
| `llm_default_model` | qwen2.5 |
| `llm_temperature` | 0.7 |
| `bypass_enabled` | true |
| `nuance_enabled` | true |

### Nuances

| Key | Name |
|-----|------|
| `engineering` | Engineering Mode |
| `creative` | Creative Mode |
| `formal` | Formal Mode |
| `academic` | Academic Mode |
| `concise` | Concise Mode |

---

## Breaking Changes

**None** - All changes are additive. Existing chat behavior is preserved.

---

## Files Changed

### New Files
- `pkg/ai/router/parser.go`
- `pkg/ai/router/router.go`
- `pkg/ai/router/resolver.go`
- `pkg/ai/pipeline/bypass.go`
- `pkg/ai/pipeline/rag.go`
- `internal/entity/ai_config_entity.go`
- `internal/model/ai_config_model.go`
- `internal/dto/ai_config_dto.go`
- `internal/repository/contract/ai_config_repository.go`
- `internal/repository/implementation/ai_config_repository_impl.go`
- `pkg/admin/aiconfig/manager.go`
- `cmd/seed_ai_config/main.go`

### Modified Files
- `internal/service/chatbot_service.go`
- `internal/service/admin_service.go`
- `internal/controller/admin_controller.go`
- `internal/bootstrap/container.go`
- `internal/repository/unitofwork/unit_of_work.go`
- `internal/repository/unitofwork/unit_of_work_impl.go`
- `cmd/migrate/main.go`
