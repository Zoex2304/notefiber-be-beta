# v1.7.3 RAG Structured Calculation & Citation Formatting (Frontend)

## üöÄ Overview

To improve the accuracy and readability of financial and numerical answers, the RAG Chatbot now outputs calculations in a **strict structured format**.

The frontend needs to parse this format and render it using a math typesetting library (KaTeX recommended) and structured UI components.

## üìù New Output Format

### 1. Calculations

For queries involving math (profit, counting, etc.), the bot response will contain sections marked with bold headers:

```text
**Sources:**
- [Source Note Title]: value_name = value
- [Another Note]: value_name = value

**Calculation:**
Step 1: Revenue = 100 * 50 = 5000
Step 2: Total = 5000 - 200 = 4800

**Final Answer:**
Profit = 4800
```

### 2. Citations

Inline citations like `[N1]`, `(Reference [N2])` have been **removed**.
Instead, the bot uses natural language: "According to Note Title..."

The frontend should continue to use the explicit `citations` array in the API response to render clickable pills below the message or in a side panel.

## üé® Frontend Implementation Guide

### A. Parsing Strategy

Do NOT treat the entire message as Markdown only. You should apply a specialized parser for the calculation blocks.

**Regex Pattern to detect calculation block:**
```regex
/\*\*Sources:\*\*([\s\S]*?)\*\*Calculation:\*\*([\s\S]*?)\*\*Final Answer:\*\*([\s\S]*?)$/
```

### B. Rendering Logic

1.  **Sources Section**:
    *   Parse lines starting with `-`.
    *   Render as a card or list.
    *   Highlight the `[Note Title]` (potentially linking to the note if matched with citation data).

2.  **Calculation Section**:
    *   Parse lines starting with `Step X:`.
    *   **Crucial**: The content after the colon usually contains mathematical formulas.
    *   **Action**: Wrap the mathematical part in LaTeX delimiters `$$` or `\[ \]` and render using **KaTeX**.
    *   *Example Conversion*:
        *   Input: `Step 1: Revenue = 1,200 * 50 = 60,000`
        *   Render: `Step 1: $$ \text{Revenue} = 1,200 \times 50 = 60,000 $$`

3.  **Final Answer Section**:
    *   Render prominently (e.g., large text, green border).
    *   Apply LaTeX rendering to the formula/value.

### C. Example Parsing (Pseudo-Code)

```javascript
const rawResponse = "..."; // Bot response

if (rawResponse.includes("**Calculation:**")) {
  const parts = parseCalculationBlock(rawResponse);
  
  return (
    <div className="rag-answer">
      <SourcesList items={parts.sources} />
      <CalculationSteps steps={parts.steps} renderMath={(tex) => <KaTeX math={tex} />} />
      <FinalResult value={parts.final} />
    </div>
  );
} else {
  return <MarkdownRenderer content={rawResponse} />;
}
```

### D. Citation Pills

Continue using the structured `data.reply.citations` array from the API response (`GET /api/chatbot`).

```json
"citations": [
  { "note_id": "uuid", "title": "Monthly Revenue Summary" }
]
```

-   Render these as interactive pills.
-   When clicked, open the corresponding note reference.
