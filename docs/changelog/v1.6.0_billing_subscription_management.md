# Changelog v1.6.0 - Billing & Subscription Management

**Release Date**: 2026-01-04

## Summary

This release introduces comprehensive billing information management, subscription cancellation workflow with admin oversight, and subscription validation for frontend expiration checks.

---

## Features

### 1. Admin Billing CRUD API
Full CRUD operations for managing user billing addresses.

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/admin/users/:id/billing` | Get user's billing addresses |
| POST | `/api/admin/users/:id/billing` | Create billing address for user |
| PUT | `/api/admin/billing/:id` | Update billing address |
| DELETE | `/api/admin/billing/:id` | Delete billing address |

---

### 2. User Billing Endpoint
Billing info exposure for Settings page.

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/user/billing` | Get default billing info |
| PUT | `/api/user/billing` | Update billing info |

---

### 3. Subscription Cancellation Flow

**User Endpoints:**
| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | `/api/user/cancellation` | Request subscription cancellation |
| GET | `/api/user/cancellations` | View cancellation history |

**Admin Endpoints:**
| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/admin/cancellations` | List all cancellation requests |
| POST | `/api/admin/cancellations/:id/process` | Approve/reject cancellation |

---

### 4. Billing Expiration Check
Lazy evaluation endpoint for subscription validity.

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/payment/validate` | Check subscription validity |

---

## TypeScript Interfaces

### Billing DTOs

```typescript
// Admin Billing Response
interface AdminBillingListResponse {
  id: string;
  user_id: string;
  first_name: string;
  last_name: string;
  email: string;
  phone?: string;
  address_line1: string;
  address_line2?: string;
  city: string;
  state: string;
  postal_code: string;
  country: string;
  is_default: boolean;
  created_at: string;
  updated_at: string;
}

// User Billing Response (Settings Page)
interface UserBillingResponse {
  id: string;
  first_name: string;
  last_name: string;
  email: string;
  phone?: string;
  address_line1: string;
  address_line2?: string;
  city: string;
  state: string;
  postal_code: string;
  country: string;
}

// User Billing Update Request
interface UserBillingUpdateRequest {
  first_name: string;
  last_name: string;
  email: string;
  phone?: string;
  address_line1: string;
  address_line2?: string;
  city: string;
  state: string;
  postal_code: string;
  country: string;
}
```

### Cancellation DTOs

```typescript
// User Cancellation Request
interface UserCancellationRequest {
  subscription_id: string;
  reason: string; // min 10 chars
}

// User Cancellation Response
interface UserCancellationResponse {
  cancellation_id: string;
  status: 'pending' | 'approved' | 'rejected';
  message: string;
}

// User Cancellation List Item
interface UserCancellationListResponse {
  id: string;
  subscription_id: string;
  plan_name: string;
  reason: string;
  status: 'pending' | 'approved' | 'rejected';
  effective_date: string;
  created_at: string;
}

// Admin Process Cancellation Request
interface AdminProcessCancellationRequest {
  action: 'approve' | 'reject';
  admin_notes?: string;
}
```

### Subscription Validation DTO

```typescript
// Validation Response
interface SubscriptionValidationResponse {
  is_valid: boolean;
  status: 'active' | 'grace_period' | 'expired' | 'free_tier' | 'canceled' | 'inactive';
  renewal_required: boolean;
  current_period_end?: string;
  days_remaining?: number;
  grace_period_end?: string;
  plan_name?: string;
}
```

---

## Database Changes

### New Table: `cancellations`

```sql
CREATE TABLE cancellations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  subscription_id UUID NOT NULL REFERENCES user_subscriptions(id),
  user_id UUID NOT NULL REFERENCES users(id),
  reason TEXT,
  status VARCHAR(50) DEFAULT 'pending',
  admin_notes TEXT,
  effective_date TIMESTAMP NOT NULL,
  processed_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  deleted_at TIMESTAMP
);

CREATE INDEX idx_cancellations_user_id ON cancellations(user_id);
CREATE INDEX idx_cancellations_status ON cancellations(status);
CREATE INDEX idx_cancellations_subscription_id ON cancellations(subscription_id);
```

---

## Files Changed

### New Files
- `internal/dto/billing_dto.go` - Billing DTOs
- `internal/dto/cancellation_dto.go` - Cancellation and validation DTOs
- `internal/entity/cancellation_entity.go` - Cancellation entity
- `internal/model/cancellation_model.go` - GORM model
- `internal/repository/contract/cancellation_repository.go` - Repository interface
- `internal/repository/implementation/cancellation_repository_impl.go` - Repository impl

### Modified Files
- `internal/service/admin_service.go` - Added billing CRUD and cancellation management
- `internal/service/user_service.go` - Added user billing and cancellation methods
- `internal/service/payment_service.go` - Added ValidateSubscription method
- `internal/controller/admin_controller.go` - Added billing and cancellation routes
- `internal/controller/user_controller.go` - Added billing and cancellation routes
- `internal/controller/payment_controller.go` - Added validate route
- `internal/repository/unitofwork/unit_of_work.go` - Added CancellationRepository
- `internal/repository/unitofwork/unit_of_work_impl.go` - Implemented CancellationRepository

---

## Migration Notes

1. Run GORM auto-migration to create `cancellations` table
2. Existing billing addresses are preserved
3. Existing subscriptions with `status = 'canceled'` are unaffected
