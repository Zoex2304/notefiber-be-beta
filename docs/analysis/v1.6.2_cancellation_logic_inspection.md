# Inspection Report: Cancellation Logic & Data Flow

**Date**: 2026-01-04
**Service**: Backend (Payment Service)
**Version**: v1.6.1

## problem Description
The user reported that upon admin approval of a subscription cancellation, the user is immediately transitioned to a "Free plan" state on the frontend, even if their billing period has not yet expired.

**Expected Behavior:**
- Cancellation approval stops **future renewals**.
- The user retains **Pro access** until the `CurrentPeriodEnd` date.
- `ValidateSubscription` should return `IsValid: true` while `Now < CurrentPeriodEnd`.

**Actual Behavior:**
- Cancellation approval immediately revokes access.
- `ValidateSubscription` returns `IsValid: false` as soon as the status is updated to `canceled`.

---

## Root Cause Analysis

The issue lies in the `ValidateSubscription` method within `internal/service/payment_service.go`.

### Current Logic Flow
1. **Active Check:** The system looks for a subscription where `Status == Active` and `PaymentStatus == Paid`.
   ```go
   if sub.Status == entity.SubscriptionStatusActive && sub.PaymentStatus == entity.PaymentStatusPaid {
       activeSub = sub
   }
   ```
   *Result:* Because the admin sets the status to `Canceled` immediately upon approval, this check fails.

2. **Inactive Handling (The Bug):** If no active subscription is found, it falls back to checking for `Canceled` status.
   ```go
   if activeSub == nil {
       for _, sub := range subs {
           if sub.Status == entity.SubscriptionStatusCanceled {
               return &dto.SubscriptionValidationResponse{
                   IsValid:         false, // <--- IMMEDIATE INVALIDATION
                   Status:          "canceled",
                   RenewalRequired: true,
               }, nil
           }
       }
       // ...
   }
   ```
   *Result:* The code immediately returns `IsValid: false` solely based on the status, completely ignoring the `CurrentPeriodEnd` date.

---

## Proposed Solution (Patch v1.6.2)

We must modify the logic to treat `Canceled` subscriptions as potentially valid if their billing period has not yet expired.

### Logic Changes
1. **Broaden Active Search:** When looking for a valid subscription, consider `Canceled` status as candidates **IF** `CurrentPeriodEnd > Now`.
2. **Conditional Validation:**
   - If `Status == Canceled` AND `Now < CurrentPeriodEnd`: Return `IsValid: true`, `Status: canceled` (or `active` with a flag), and `DaysRemaining`.
   - If `Status == Canceled` AND `Now > CurrentPeriodEnd`: Return `IsValid: false`, `Status: expired`.

### Revised Logic Draft

```go
// Check for valid access (Active OR Canceled-but-not-expired)
for _, sub := range subs {
    // Check Active
    if sub.Status == entity.SubscriptionStatusActive && sub.PaymentStatus == entity.PaymentStatusPaid {
        activeSub = sub
        break
    }
    // Check Canceled but valid period
    if sub.Status == entity.SubscriptionStatusCanceled && sub.CurrentPeriodEnd.After(time.Now()) {
        activeSub = sub // Treat as active for validation purposes
        break
    }
}
```

If a canceled subscription is selected as `activeSub`:
- `IsValid` will be calculated as `true`.
- `Status` will be passed as `canceled` (which the frontend should interpret as "Active but won't renew").
- `RenewalRequired` should be `true` to indicate they need to resubscribe to keep access after this period.

---

## Conclusion
The backend is producing incorrect data (immediate invalidation). A patch is required in `internal/service/payment_service.go`.
